<html>
  <head>
    <meta charset = "UTF-8">
    <meta name = "Description" content = "Universal smooth scroll demo">
    <meta name = "viewport" content = "width=device-width, initial-scale=1.0">
    <title>Universal Smooth Scroll</title>
    <link rel = "icon" type = "image/png" href = "./images/favicon.png">
    <link rel = "stylesheet" type = "text/css" href = "./css/universalsmoothscroll.css">
    <!--<script async src = "https://rawcdn.githack.com/CristianDavideConte/universalSmoothScroll/41d6bbb80203a81e4dab942fe0328b9c237d823f/js/universalsmoothscroll-min.js"></script>-->
    <!--<script async src = "https://raw.githack.com/CristianDavideConte/universalSmoothScroll/master/js/universalsmoothscroll-min.js"></script>-->
    <script async src = "./js/universalsmoothscroll.js"></script>
  </head>
  <body onload = "init()" oncontextmenu = "return false">
    <section id = "stopScrollingButtonsSection">
      <button id = "stopScrollingX">STOP X</button>
      <button id = "stopScrollingY">STOP Y</button>
    </section>
    <nav id = "header">
      <ul>
        <li><a href = "#section1">YELLOW</a></li>
        <li><a href = "#section2">BLUE</a></li>
        <li><a href = "#section4">GREEN</a></li>
        <li><a href = "#section3">RED</a></li>
      </ul>
    </nav>

    <!--SECTION 1 AND 2 -->
    <div class = "sections-container">
      <div id = "section1" class = "page">
        <div id = "easeFunctionSelector">
          <h2>Change Ease Function</h2>
          <ul>
            <li><a id = "linear"        >linear</a></li>
            <li><a id = "easeInQuart"   >easeInQuart</a></li>
            <li><a id = "easeInQuint"   >easeInQuint</a></li>
            <li><a id = "easeOutCirc"   >easeOutCirc</a></li>
            <li><a id = "easeOutExpo"   >easeOutExpo</a></li>
            <li><a id = "easeInOutQuint">easeInOutQuint</a></li>
            <li><a id = "easeInOutCirc" >easeInOutCirc</a></li>
            <li><a id = "easeInOutExpo" >easeInOutExpo</a></li>
          </ul>
        </div>
      </div>
      <div id = "section2" class = "page">
        <section id = "yScroller">
          <button id = "yScrollerUp">&uarr;</button>
          <div class = "scrollerSections">
            <div id = "section12" class = "listItem"></div>
            <div id = "section22" class = "listItem"></div>
            <div id = "section32" class = "listItem"></div>
            <div id = "section42" class = "listItem"></div>
          </div>
          <button id = "yScrollerDown">&darr;</button>
        </section>
      </div>
    </div>

    <!--SECTION 3 AND 4 -->
    <div class = "sections-container">
      <div id = "section3" class = "page">
        <section id = "xScroller">
          <button id = "xScrollerLeft">&larr;</button>
          <div id = "xScrollerSection" class = "scrollerSections">
            <div id = "section11" class = "listItem"></div>
            <div id = "section21" class = "listItem"></div>
            <div id = "section31" class = "listItem"></div>
            <div id = "section41" class = "listItem"></div>
          </div>
          <button id = "xScrollerRight">&rarr;</button>
        </section>
      </div>
      <div id = "section4" class = "page">
        <div id = "customBezierParameterSection">
          <h2 id = "bezierTitle">Choose custom cubic-bezier parameters</h2>
          <ul>
            <li><input type = "text" class = "cubicBezierParameter" value = "0"/></li>
            <li><input type = "text" class = "cubicBezierParameter" value = "0"/></li>
            <li><input type = "text" class = "cubicBezierParameter" value = "1"/></li>
            <li><input type = "text" class = "cubicBezierParameter" value = "1"/></li>
          </ul>
          <input type = "submit" value = "Customize"></input>
        </div>
      </div>
    </div>
  </body>
</html>
<script>
  function init() {
    const body = document.body;

    let yScroller = document.getElementsByClassName("scrollerSections")[0];
    let yScrollerUpButton = document.getElementById("yScrollerUp");
    let yScrollerDownButton = document.getElementById("yScrollerDown");

    let xScroller = document.getElementsByClassName("scrollerSections")[1];
    let xScrollerLeftButton = document.getElementById("xScrollerLeft");
    let xScrollerRightButton = document.getElementById("xScrollerRight");

    let cubicBezierCustomInputParameters = document.getElementsByTagName("input");

    let uss_ext = {
      _xMapContainerAnimationProgress: new Map(),
      _yMapContainerAnimationProgress: new Map(),
      _bezierStepLength: () => {return 1 / uss.getMinAnimationFrame();},
      _bezierCalculator: function (p1x, p1y, p2x, p2y) {
        if(typeof p1x !== "number" || typeof p1y !== "number" || typeof p2x !== "number" || typeof p2y !== "number") {
          console.error("USSE Error: invalid cubic bezier parameters");
          return;
        }

        const _inputCheck = p1x > 1 || p1x < 0 || p1y > 1 || p1y < 0 || p2x > 1 || p2x < 0 || p2y > 1 || p2y < 0;
        if(_inputCheck) {console.error("USSE Error: invalid cubic bezier parameters"); return;}

        // Calculate constants in parametric bezier formular
        // http://www.moshplant.com/direct-or/bezier/math.html
        const cX = 3 * p1x;
        const bX = 3 * (p2x - p1x) - cX;
        const aX = 1 - cX - bX;
        const cY = 3 * p1y;
        const bY = 3 * (p2y - p1y) - cY;
        const aY = 1 - cY - bY;

        // Functions for calculating x, x', y for t
        function bezierX(t) {
          return t * (cX + t * (bX + t * aX)); //ax * t^3 + bx * t^2 + cx * t
        }

        function bezierXDerivative(t) {
          return cX + t * (2 * bX + 3 * aX * t); //ax * t^2 + bx * t + cx
        }

        // Use Newton-Raphson method to find t for a given x.
        // Since x = a*t^3 + b*t^2 + c*t, we find the root for
        // a*t^3 + b*t^2 + c*t - x = 0, and thus t.
        function newtonRaphson(x) { //Tangent Method
          if(x === 0) return 0;
          let prev;
          let t = x; // Initial estimation is linear
          do {
            prev = t;
            t = t - ((bezierX(t) - x) / bezierXDerivative(t));
          } while (Math.abs(t - prev) > 1e-4);

          return t;
        }

        return (x) => {
          const t = newtonRaphson(x);
          return t * ( cY + t * ( bY + t * aY )); // This is y given t on the bezier curve
        }
      },
      _ease: function (total, container, easeFunction) {
        // 0 = scroll-animation requested by _stepX
        // 1 = scroll-animation requested by _stepY
        //-1 = scroll-animation requested by something else, no state saved
        const _stack = (new Error()).stack;
        const _axis = _stack.includes("_stepX") ? 0 : _stack.includes("_stepY") ? 1 : -1;

        let _animationProgresses;
        let currentXBezier;
        let nextXBezier;
        const _stepLength = uss_ext._bezierStepLength();

        if(_axis === 0) {
          _animationProgresses = uss_ext._xMapContainerAnimationProgress.get(container) || [0];
          currentXBezier = _animationProgresses[0];
          nextXBezier = currentXBezier + _stepLength;
          _animationProgresses.shift();
          if(nextXBezier < 1) _animationProgresses.push(nextXBezier);
          uss_ext._xMapContainerAnimationProgress.set(container, _animationProgresses);
        } else if(_axis === 1) {
          _animationProgresses = uss_ext._yMapContainerAnimationProgress.get(container) || [0];
          currentXBezier = _animationProgresses[0];
          nextXBezier = currentXBezier + _stepLength;
          _animationProgresses.shift();
          if(nextXBezier < 1) _animationProgresses.push(nextXBezier);
          uss_ext._yMapContainerAnimationProgress.set(container, _animationProgresses);
        } else {
          currentXBezier = 0;
          nextXBezier = currentXBezier + _stepLength;
        }

        return Math.abs(easeFunction(currentXBezier) - easeFunction(nextXBezier)) * total + 1;
      },
      _resetXProgress: function (container = window) {
        uss_ext._xMapContainerAnimationProgress.set(container, [0]);
      },
      _resetYProgress: function (container = window) {
        uss_ext._yMapContainerAnimationProgress.set(container, [0]);
      },
      _resetProgress: function (container = window) {
        uss_ext._xMapContainerAnimationProgress.set(container, [0]);
        uss_ext._yMapContainerAnimationProgress.set(container, [0]);
      },
      cubicBezier: function (remaning, time, total, currentPos, finalPos, container, p1x, p1y, p2x, p2y) {
        return uss_ext._ease(total, container, uss_ext._bezierCalculator(p1x, p1y, p2x, p2y));
      },
      linear: function (remaning, time, total, currentPos, finalPos, container) {
        return uss_ext._ease(total, container, uss_ext._bezierCalculator(0, 0, 1, 1));
      },
      easeInQuart: function (remaning, time, total, currentPos, finalPos, container) {
        return uss_ext._ease(total, container, uss_ext._bezierCalculator(0.5, 0, 0.75, 0));
      },
      easeInQuint: function (remaning, time, total, currentPos, finalPos, container) {
        return uss_ext._ease(total, container, uss_ext._bezierCalculator(0.64, 0, 0.78, 0));
      },
      easeOutCirc: function (remaning, time, total, currentPos, finalPos, container) {
        return uss_ext._ease(total, container, uss_ext._bezierCalculator(0, 0.55, 0.45, 1));
      },
      easeOutExpo: function (remaning, time, total, currentPos, finalPos, container) {
        return uss_ext._ease(total, container, uss_ext._bezierCalculator(0.16, 1, 0.3, 1));
      },
      easeInOutQuint: function (remaning, time, total, currentPos, finalPos, container) {
        return uss_ext._ease(total, container, uss_ext._bezierCalculator(0.83, 0, 0.17, 1));
      },
      easeInOutCirc: function (remaning, time, total, currentPos, finalPos, container) {
        return uss_ext._ease(total, container, uss_ext._bezierCalculator(0.85, 0, 0.15, 1));
      },
      easeInOutExpo: function (remaning, time, total, currentPos, finalPos, container) {
        return uss_ext._ease(total, container, uss_ext._bezierCalculator(0.87, 0, 0.13, 1));
      }
    }


    uss.hrefSetup(true, true, () => uss_ext._resetProgress(body), null, false);
    uss.setYStepLength(uss.getXStepLength());
    uss.setMinAnimationFrame(30);
    uss.setStepLengthCalculator(uss_ext.linear, body);

    document.getElementById("linear").addEventListener("click",         () => uss.setStepLengthCalculator(uss_ext.linear, body));
    document.getElementById("easeInQuart").addEventListener("click",    () => uss.setStepLengthCalculator(uss_ext.easeInQuart, body));
    document.getElementById("easeInQuint").addEventListener("click",    () => uss.setStepLengthCalculator(uss_ext.easeInQuint, body));
    document.getElementById("easeOutCirc").addEventListener("click",    () => uss.setStepLengthCalculator(uss_ext.easeOutCirc, body));
    document.getElementById("easeOutExpo").addEventListener("click",    () => uss.setStepLengthCalculator(uss_ext.easeOutExpo, body));
    document.getElementById("easeInOutQuint").addEventListener("click", () => uss.setStepLengthCalculator(uss_ext.easeInOutQuint, body));
    document.getElementById("easeInOutCirc").addEventListener("click",  () => uss.setStepLengthCalculator(uss_ext.easeInOutCirc, body));
    document.getElementById("easeInOutExpo").addEventListener("click",  () => uss.setStepLengthCalculator(uss_ext.easeInOutExpo, body));



    function scrollListX(direction) {
      const finalXPosition = (direction === -1) ? 0 : uss.getMaxScrollX(xScroller);
      uss.scrollXTo(finalXPosition, xScroller, null, true);
    }

    xScrollerLeftButton.addEventListener("mousedown",   () => scrollListX(-1), {passive: false});
    xScrollerRightButton.addEventListener("mousedown",  () => scrollListX(+1), {passive: false});
    xScrollerLeftButton.addEventListener("touchstart",  () => scrollListX(-1), {passive: false});
    xScrollerRightButton.addEventListener("touchstart", () => scrollListX(+1), {passive: false});

    xScrollerLeftButton.addEventListener("touchend",  () => uss.stopScrollingX(xScroller), {passive:false});
    xScrollerRightButton.addEventListener("touchend", () => uss.stopScrollingX(xScroller), {passive:false});
    xScrollerLeftButton.addEventListener("mouseup",   () => uss.stopScrollingX(xScroller), {passive:false});
    xScrollerRightButton.addEventListener("mouseup",  () => uss.stopScrollingX(xScroller), {passive:false});
    xScrollerLeftButton.addEventListener("mouseout",  () => uss.stopScrollingX(xScroller), {passive:false});
    xScrollerRightButton.addEventListener("mouseout", () => uss.stopScrollingX(xScroller), {passive:false});

    function scrollListY(direction) {
      const finalYPosition = (direction === -1) ? 0 : uss.getMaxScrollY(yScroller);
      uss.scrollYTo(finalYPosition, yScroller, null, true);
    }
    yScrollerUpButton.addEventListener("mousedown",    () => scrollListY(-1), {passive: false});
    yScrollerDownButton.addEventListener("mousedown",  () => scrollListY(+1), {passive: false});
    yScrollerUpButton.addEventListener("touchstart",   () => scrollListY(-1), {passive: false});
    yScrollerDownButton.addEventListener("touchstart", () => scrollListY(+1), {passive: false});

    yScrollerUpButton.addEventListener("touchend",   () => uss.stopScrollingY(yScroller), {passive:false});
    yScrollerDownButton.addEventListener("touchend", () => uss.stopScrollingY(yScroller), {passive:false});
    yScrollerUpButton.addEventListener("mouseup",    () => uss.stopScrollingY(yScroller), {passive:false});
    yScrollerDownButton.addEventListener("mouseup",  () => uss.stopScrollingY(yScroller), {passive:false});
    yScrollerUpButton.addEventListener("mouseout",   () => uss.stopScrollingY(yScroller), {passive:false});
    yScrollerDownButton.addEventListener("mouseout", () => uss.stopScrollingY(yScroller), {passive:false});

    let bezierTitleTimeout = 0;
    cubicBezierCustomInputParameters[4].addEventListener("click", () => {
      window.clearTimeout(bezierTitleTimeout);
      let p1x, p1y, p2x, p2y;
      const title = document.getElementById("bezierTitle");

      p1x = Number.parseFloat(cubicBezierCustomInputParameters[0].value);
      p1y = Number.parseFloat(cubicBezierCustomInputParameters[1].value);
      p2x = Number.parseFloat(cubicBezierCustomInputParameters[2].value);
      p2y = Number.parseFloat(cubicBezierCustomInputParameters[3].value);

      if(isNaN(p1x) || isNaN(p1y) || isNaN(p2x) || isNaN(p2y)) {
        title.innerHTML = "Parameters must be numbers from 0 to 1";
        bezierTitleTimeout = window.setTimeout(() => title.innerHTML = "Choose custom cubic-bezier parameters", 5000);
        return;
      }

      const _inputCheck = p1x > 1 || p1x < 0 || p1y > 1 || p1y < 0 || p2x > 1 || p2x < 0 || p2y > 1 || p2y < 0;
      if(_inputCheck) {
        title.innerHTML = "Parameters must be numbers from 0 to 1";
        bezierTitleTimeout = window.setTimeout(() => title.innerHTML = "Choose custom cubic-bezier parameters", 5000);
        return;
      }

      uss.setStepLengthCalculator((remaning, time, total, currentPos, finalPos, container) => uss_ext.cubicBezier(remaning, time, total, currentPos, finalPos, container, p1x, p1y, p2x, p2y), body);
      title.innerHTML = "All set, try it out !";
      bezierTitleTimeout = window.setTimeout(() => title.innerHTML = "Choose custom cubic-bezier parameters", 5000);
    }, {passive:true});

    body.addEventListener("wheel", () => {uss.stopScrollingY(body); uss.stopScrollingX(body, () => console.log("User Interacted: every scroll has been stopped"));}, {passive:false});
    document.getElementById("stopScrollingX").addEventListener("click", () => uss.stopScrollingX(body, () => console.log("scrollX stopped")), {passive:false});
    document.getElementById("stopScrollingY").addEventListener("click", () => uss.stopScrollingY(body, () => console.log("scrollY stopped")), {passive:false});
  }
</script>
