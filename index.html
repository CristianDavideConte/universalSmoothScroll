<html>
  <head>
    <meta charset = "UTF-8">
    <meta name = "Description" content = "Universal smooth scroll demo">
    <meta name = "viewport" content = "width=device-width, initial-scale=1.0">
    <title>Universal Smooth Scroll</title>
    <link rel = "icon" type = "image/png" href = "./images/new_favicon.png">
    <link rel = "stylesheet" type = "text/css" href = "./css/universalsmoothscroll.css">
    <script async src = "./js/universalsmoothscroll.js"></script>
    <script async src = "./js/universalsmoothscroll-ease-functions.js"></script>
  </head>
  <body onload = "init()">
    <section id = "stopScrollingButtonsSection">
      <button id = "stopScrollingX">STOP X</button>
      <button id = "stopScrollingY">STOP Y</button>
    </section>
    <nav id = "header">
      <ul>
        <li><a href = "#section1">YELLOW</a></li>
        <li><a href = "#section2">BLUE</a></li>
        <li><a href = "#section4">GREEN</a></li>
        <li><a href = "#section3">RED</a></li>
      </ul>
    </nav>
    
    <!-- FOR EASE TESTING ONLY 
    <canvas id = "myCanvas" width="906" height="909">
      test
    </canvas> -->
    
    <!--SECTION 1 AND 2 -->
    <div class = "sections-container">
      <div id = "section1" class = "page">
        <div id = "easeFunctionSelector">
          <h2>Select the above anchor's easing</h2>
          <ul id = "easeFunctionSelectorList">
            <li><a id = "linear"        >linear</a></li>
            <li><a id = "easeInSine"    >easeInSine</a></li>
            <li><a id = "easeInQuad"    >easeInQuad</a></li>
            <li><a id = "easeInCubic"   >easeInCubic</a></li>
            <li><a id = "easeInQuart"   >easeInQuart</a></li>
            <li><a id = "easeInQuint"   >easeInQuint</a></li>
            <li><a id = "easeInExpo"    >easeInExpo</a></li>
            <li><a id = "easeInCirc"    >easeInCirc</a></li>
            <li><a id = "easeOutSine"   >easeOutSine</a></li>
            <li><a id = "easeOutQuad"   >easeOutQuad</a></li>
            <li><a id = "easeOutCubic"  >easeOutCubic</a></li>
            <li><a id = "easeOutQuart"  >easeOutQuart</a></li>
            <li><a id = "easeOutQuint"  >easeOutQuint</a></li>
            <li><a id = "easeOutExpo"   >easeOutExpo</a></li>
            <li><a id = "easeOutCirc"   >easeOutCirc</a></li>
            <li><a id = "easeInOutSine" >easeInOutSine</a></li>
            <li><a id = "easeInOutQuad" >easeInOutQuad</a></li>
            <li><a id = "easeInOutCubic">easeInOutCubic</a></li>
            <li><a id = "easeInOutQuart">easeInOutQuart</a></li>
            <li><a id = "easeInOutQuint">easeInOutQuint</a></li>
            <li><a id = "easeInOutExpo" >easeInOutExpo</a></li>
            <li><a id = "easeInOutCirc" >easeInOutCirc</a></li>

            <li><a id = "easeInBounce"  >easeInBounce</a></li>
            <li><a id = "easeOutBounce" >easeOutBounce</a></li>
            <li><a id = "easeInOutBounce" >easeInOutBounce</a></li>
          </ul>
        </div>
      </div>
      <div id = "section2" class = "page">
        <section id = "yScroller">
          <button id = "yScrollerUp">&uarr;</button>
          <div id = "yScrollerSection" class = "scrollerSections">
            <div id = "section12" class = "listItem"></div>
            <div id = "section22" class = "listItem"></div>
            <div id = "section32" class = "listItem"></div>
            <div id = "section42" class = "listItem"></div>
          </div>
          <button id = "yScrollerDown">&darr;</button>
        </section>
      </div>
    </div>

    <!--SECTION 3 AND 4 -->
    <div class = "sections-container">
      <div id = "section3" class = "page">
        <section id = "xScroller">
          <button id = "xScrollerLeft">&larr;</button>
          <div id = "xScrollerSection" class = "scrollerSections">
            <div id = "section11" class = "listItem"></div>
            <div id = "section21" class = "listItem"></div>
            <div id = "section31" class = "listItem"></div>
            <div id = "section41" class = "listItem"></div>
          </div>
          <button id = "xScrollerRight">&rarr;</button>
        </section>
      </div>
      <div id = "section4" class = "page">
        <div id = "customBezierParameterSection">
          <h2 id = "bezierTitle">Choose custom cubic-bezier parameters</h2>
          <ul>
            <li><input type = "text" class = "cubicBezierParameter" value = "0"/></li>
            <li><input type = "text" class = "cubicBezierParameter" value = "0"/></li>
            <li><input type = "text" class = "cubicBezierParameter" value = "1"/></li>
            <li><input type = "text" class = "cubicBezierParameter" value = "1"/></li>
          </ul>
          <input type = "submit" value = "Customize"></input>
        </div>
      </div>
    </div>
  </body>
</html>
<script>
  //Enables smooth scrolling for touch devices
  let isFingerDown;
  function touchHelper(container, init, callback, scrollModifier = delta => {return delta;}, shouldTrackFinger = false, onfingerUp = () => {}) {
    let _Y = null;
    let _X = null;

    container.addEventListener("touchstart", event => {
      event.stopPropagation();
      if(event.touches.length > 1) return;
      _Y = null;
      _X = null;
      if(event.target.href === undefined) uss.stopScrolling(container);
      if(shouldTrackFinger) isFingerDown = true;
    }, {passive:true});

    container.addEventListener("touchend", event => {
      event.stopPropagation();
  		if(event.touches.length > 1) return;
      _Y = null;
      _X = null;
      if(shouldTrackFinger) {
        isFingerDown = false;
        onfingerUp();
      }
    }, {passive:true});

    container.addEventListener("touchmove", event => {
      event.stopPropagation();
      event.preventDefault();

  		if(event.touches.length > 1) return;
      if(typeof init === "function") init();

      if(_X === null) _X = event.changedTouches[0].clientX;
      if(_Y === null) _Y = event.changedTouches[0].clientY;
      const _originalDeltaX = _X - event.changedTouches[0].clientX;
      const _originalDeltaY = _Y - event.changedTouches[0].clientY;
      _X -= _originalDeltaX;
      _Y -= _originalDeltaY;
      const _absDeltaX = Math.abs(_originalDeltaX);
      const _absDeltaY = Math.abs(_originalDeltaY);

      const _deltaX = _absDeltaX <= 1 ? _originalDeltaX : _originalDeltaX * Math.log(1e5 * _absDeltaX);
      const _deltaY = _absDeltaY <= 1 ? _originalDeltaY : _originalDeltaY * Math.log(1e5 * _absDeltaY);
      
      uss.scrollBy(scrollModifier(_deltaX), scrollModifier(_deltaY), container, callback, true);
    }, {passive:false});
  }








  let backwardPhase;
  function calcScrollDistance(container, scrollLimit, delta, wasTouchEvent = false) { 
    const _finalPos = wasTouchEvent ? uss.getScrollYCalculator(container)() : uss.getFinalYPosition(container);
    const _maxScroll = uss.getMaxScrollY(container);

    if(_finalPos < scrollLimit && delta < 0) {
      const _progress = _finalPos / scrollLimit;
      return delta * Math.pow(_progress, 4); //delta * (1-x)^4
    }

    if(_finalPos > _maxScroll - scrollLimit && delta > 0) {
      const _progress = (_maxScroll - _finalPos) / scrollLimit;
      return delta * Math.pow(_progress, 4); //delta * (1-x)^4
    }

    return delta;
  }






  function init() {
    const pageScroller = document.body;
    const defaultEase = EASE_OUT_CUBIC(1000);

    let yScrollerSection = document.getElementsByClassName("scrollerSections")[0];
    let yScrollerUpButton = document.getElementById("yScrollerUp");
    let yScrollerDownButton = document.getElementById("yScrollerDown");

    let xScrollerSection = document.getElementsByClassName("scrollerSections")[1];
    let xScrollerLeftButton = document.getElementById("xScrollerLeft");
    let xScrollerRightButton = document.getElementById("xScrollerRight");

    let cubicBezierCustomInputParameters = document.getElementsByTagName("input");
    let easeFunctionSelectorList = document.getElementById("easeFunctionSelectorList");

    let lastAnchorPressed = null;


    uss.setPageScroller(pageScroller);
    uss.setStepLengthCalculator(EASE_LINEAR());

    uss.hrefSetup(null, true, (anchor, el) => {
      if(anchor !== window && lastAnchorPressed === anchor && uss.isScrolling()) return false;
      lastAnchorPressed = anchor;
      uss.setStepLengthCalculator(uss.getXStepLengthCalculator()); //Unsets the temporary StepLengthCalculator
    }, null, false, true);









    //Used to bring the easeFunctionSelectorList to initial position
    const elasticDebounceTime = 70; //Debounce time in ms
    easeFunctionSelectorList.scrollTop = 2.5 * easeFunctionSelectorList.scrollHeight / (easeFunctionSelectorList.children.length + 5);
    uss.setYStepLengthCalculator(
      EASE_ELASTIC_Y(
        (r) => r / 20 + 1,
        EASE_OUT_BOUNCE(),
        (originalTimestamp, timestamp, currentPos, direction, container) => {
          if(isFingerDown) return 0;
          backwardPhase = true;
          const _elasticLimit = 2.5 * (container.scrollHeight / (container.children.length + 5)); //Container's padding-top/bottom
          const _maxScroll = uss.getMaxScrollY(container);
          return currentPos <= _elasticLimit              ? direction * (currentPos - _elasticLimit) :
                 currentPos >= _maxScroll - _elasticLimit ? direction * (currentPos + _elasticLimit - _maxScroll) :
                 0;
        },
        elasticDebounceTime
    ), easeFunctionSelectorList);





    easeFunctionSelectorList.addEventListener("wheel", event => {
      event.preventDefault();
      event.stopPropagation();
      const _scrollDistance = calcScrollDistance(easeFunctionSelectorList, 2.5 * (easeFunctionSelectorList.scrollHeight / (easeFunctionSelectorList.children.length + 5)) - 1, event.deltaY);
      uss.scrollYBy(_scrollDistance, easeFunctionSelectorList, () => backwardPhase = false, backwardPhase);
      backwardPhase = false;
    }, {passive:false});




    let scrollbarTimeout;
    easeFunctionSelectorList.addEventListener("scroll", (event) => {
      if(isFingerDown || backwardPhase || uss.isYscrolling(easeFunctionSelectorList)) return;
      clearTimeout(scrollbarTimeout);

      const _elasticLimit = 2.5 * (easeFunctionSelectorList.scrollHeight / (easeFunctionSelectorList.children.length + 5)); //Container's padding-top/bottom
      const _currentPos = uss.getScrollYCalculator(easeFunctionSelectorList)();

      if(_currentPos < _elasticLimit - 1) {
        scrollbarTimeout = setTimeout(() => {
                            if(isFingerDown || backwardPhase || uss.isYscrolling(easeFunctionSelectorList)) return;
                            easeFunctionSelectorList.style.pointerEvents = "none";
                            easeFunctionSelectorList.style.overflowY = "hidden";
                            window.requestAnimationFrame(() => {easeFunctionSelectorList.style.overflowY = "scroll"});
                            uss.scrollYTo(_currentPos - 1, easeFunctionSelectorList, () => {easeFunctionSelectorList.style.pointerEvents = ""; backwardPhase = false;});
                          }, 1.5 * elasticDebounceTime);
        return;
      }

      const maxScroll = uss.getMaxScrollY(easeFunctionSelectorList);
      if(_currentPos > maxScroll - _elasticLimit + 1) {
        scrollbarTimeout = setTimeout(() => {
                            if(isFingerDown || backwardPhase || uss.isYscrolling(easeFunctionSelectorList)) return;
                            easeFunctionSelectorList.style.pointerEvents = "none";
                            easeFunctionSelectorList.style.overflowY = "hidden";
                            window.requestAnimationFrame(() => {easeFunctionSelectorList.style.overflowY = "scroll"});
                            uss.scrollYTo(_currentPos + 1, easeFunctionSelectorList, () => {easeFunctionSelectorList.style.pointerEvents = ""; backwardPhase = false;});
                          }, 1.5 * elasticDebounceTime);
      }
    }, {passive:false});





    touchHelper(easeFunctionSelectorList,
                null,
                null,
                delta => {return calcScrollDistance(easeFunctionSelectorList, 2.5 * (easeFunctionSelectorList.scrollHeight / (easeFunctionSelectorList.children.length + 5)), delta, true);},
                true,
                () => {
                  const _elasticLimit = 2.5 * (easeFunctionSelectorList.scrollHeight / (easeFunctionSelectorList.children.length + 5)); //Container's padding-top/bottom
                  const _currentPos = uss.getScrollYCalculator(easeFunctionSelectorList)();
                  const maxScroll = uss.getMaxScrollY(easeFunctionSelectorList);
                  if(_currentPos < _elasticLimit - 1) {
                    uss.scrollYTo(_currentPos - 1, easeFunctionSelectorList, () => backwardPhase = false);
                  } else if(_currentPos > maxScroll - _elasticLimit + 1) {
                    uss.scrollYTo(_currentPos + 1, easeFunctionSelectorList, () => backwardPhase = false);
                  }
                }
               );


















    const listItems = easeFunctionSelectorList.children;
    listItems[0].classList.add("selected");
    for(const li of listItems) {
      li.addEventListener("click", () => {
        document.getElementsByClassName("selected")[0].classList.remove("selected");
        li.classList.add("selected");
      }, {passive:true});
    }

    document.getElementById("linear").addEventListener("click",          () => uss.setStepLengthCalculator(EASE_LINEAR()));

    document.getElementById("easeInSine").addEventListener("click",      () => uss.setStepLengthCalculator(EASE_IN_SINE()));
    document.getElementById("easeInQuad").addEventListener("click",      () => uss.setStepLengthCalculator(EASE_IN_QUAD()));
    document.getElementById("easeInCubic").addEventListener("click",     () => uss.setStepLengthCalculator(EASE_IN_CUBIC()));
    document.getElementById("easeInQuart").addEventListener("click",     () => uss.setStepLengthCalculator(EASE_IN_QUART()));
    document.getElementById("easeInQuint").addEventListener("click",     () => uss.setStepLengthCalculator(EASE_IN_QUINT()));
    document.getElementById("easeInExpo").addEventListener("click",      () => uss.setStepLengthCalculator(EASE_IN_EXPO()));
    document.getElementById("easeInCirc").addEventListener("click",      () => uss.setStepLengthCalculator(EASE_IN_CIRC()));

    document.getElementById("easeOutSine").addEventListener("click",     () => uss.setStepLengthCalculator(EASE_OUT_SINE()));
    document.getElementById("easeOutQuad").addEventListener("click",     () => uss.setStepLengthCalculator(EASE_OUT_QUAD()));
    document.getElementById("easeOutCubic").addEventListener("click",    () => uss.setStepLengthCalculator(EASE_OUT_CUBIC()));
    document.getElementById("easeOutQuart").addEventListener("click",    () => uss.setStepLengthCalculator(EASE_OUT_QUART()));
    document.getElementById("easeOutQuint").addEventListener("click",    () => uss.setStepLengthCalculator(EASE_OUT_QUINT()));
    document.getElementById("easeOutExpo").addEventListener("click",     () => uss.setStepLengthCalculator(EASE_OUT_EXPO()));
    document.getElementById("easeOutCirc").addEventListener("click",     () => uss.setStepLengthCalculator(EASE_OUT_CIRC()));

    document.getElementById("easeInOutSine").addEventListener("click",   () => uss.setStepLengthCalculator(EASE_IN_OUT_SINE()));
    document.getElementById("easeInOutQuad").addEventListener("click",   () => uss.setStepLengthCalculator(EASE_IN_OUT_QUAD()));
    document.getElementById("easeInOutCubic").addEventListener("click",  () => uss.setStepLengthCalculator(EASE_IN_OUT_CUBIC()));
    document.getElementById("easeInOutQuart").addEventListener("click",  () => uss.setStepLengthCalculator(EASE_IN_OUT_QUART()));
    document.getElementById("easeInOutQuint").addEventListener("click",  () => uss.setStepLengthCalculator(EASE_IN_OUT_QUINT()));
    document.getElementById("easeInOutExpo").addEventListener("click",   () => uss.setStepLengthCalculator(EASE_IN_OUT_EXPO()));
    document.getElementById("easeInOutCirc").addEventListener("click",   () => uss.setStepLengthCalculator(EASE_IN_OUT_CIRC()));

    document.getElementById("easeInBounce").addEventListener("click",    () => uss.setStepLengthCalculator(EASE_IN_BOUNCE()));
    document.getElementById("easeOutBounce").addEventListener("click",   () => uss.setStepLengthCalculator(EASE_OUT_BOUNCE()));
    document.getElementById("easeInOutBounce").addEventListener("click", () => uss.setStepLengthCalculator(EASE_IN_OUT_BOUNCE()));


    function scrollListX(direction) {
      const finalXPosition = direction === -1 ? 0 : uss.getMaxScrollX(xScrollerSection);
      uss.scrollXTo(finalXPosition, xScrollerSection, null, true);
    }

    uss.setXStepLengthCalculator(EASE_IN_OUT_QUAD(1000), xScrollerSection);
    xScrollerSection.addEventListener("wheel", event => {
      event.preventDefault();
      event.stopPropagation();
      uss.setXStepLengthCalculator(defaultEase, xScrollerSection, true);
      uss.scrollXBy(event.deltaY, xScrollerSection, null, false);
    }, {passive:false});
    xScrollerSection.addEventListener("touchmove", event => event.stopPropagation(), {passive:true});

    xScrollerLeftButton.addEventListener("mousedown",   () => scrollListX(-1), {passive: false});
    xScrollerRightButton.addEventListener("mousedown",  () => scrollListX(+1), {passive: false});
    xScrollerLeftButton.addEventListener("touchstart",  () => scrollListX(-1), {passive: false});
    xScrollerRightButton.addEventListener("touchstart", () => scrollListX(+1), {passive: false});

    xScrollerLeftButton.addEventListener("touchmove",  event => {event.preventDefault(); event.stopPropagation();}, {passive: false});
    xScrollerRightButton.addEventListener("touchmove", event => {event.preventDefault(); event.stopPropagation();}, {passive: false});

    xScrollerLeftButton.addEventListener("touchend",  () => uss.stopScrollingX(xScrollerSection), {passive:false});
    xScrollerRightButton.addEventListener("touchend", () => uss.stopScrollingX(xScrollerSection), {passive:false});
    xScrollerLeftButton.addEventListener("mouseup",   () => uss.stopScrollingX(xScrollerSection), {passive:false});
    xScrollerRightButton.addEventListener("mouseup",  () => uss.stopScrollingX(xScrollerSection), {passive:false});
    xScrollerLeftButton.addEventListener("mouseout",  () => uss.stopScrollingX(xScrollerSection), {passive:false});
    xScrollerRightButton.addEventListener("mouseout", () => uss.stopScrollingX(xScrollerSection), {passive:false});


    function scrollListY(direction) {
      const finalYPosition = direction === -1 ? 0 : uss.getMaxScrollY(yScrollerSection);
      uss.scrollYTo(finalYPosition, yScrollerSection, null, true);
    }

    uss.setYStepLengthCalculator(EASE_OUT_EXPO(2000), yScrollerSection);
    yScrollerSection.addEventListener("wheel", event => {
      event.preventDefault();
      event.stopPropagation();
      uss.setYStepLengthCalculator(defaultEase, yScrollerSection, true);
      uss.scrollYBy(event.deltaY, yScrollerSection, null, false);
    }, {passive:false});
    yScrollerSection.addEventListener("touchmove", event => event.stopPropagation(), {passive:true});

    yScrollerUpButton.addEventListener("mousedown",    () => scrollListY(-1), {passive: false});
    yScrollerDownButton.addEventListener("mousedown",  () => scrollListY(+1), {passive: false});
    yScrollerUpButton.addEventListener("touchstart",   () => scrollListY(-1), {passive: false});
    yScrollerDownButton.addEventListener("touchstart", () => scrollListY(+1), {passive: false});

    yScrollerUpButton.addEventListener("touchmove",   event => {event.preventDefault(); event.stopPropagation();}, {passive: false});
    yScrollerDownButton.addEventListener("touchmove", event => {event.preventDefault(); event.stopPropagation();}, {passive: false});

    yScrollerUpButton.addEventListener("touchend",   () => uss.stopScrollingY(yScrollerSection), {passive:false});
    yScrollerDownButton.addEventListener("touchend", () => uss.stopScrollingY(yScrollerSection), {passive:false});
    yScrollerUpButton.addEventListener("mouseup",    () => uss.stopScrollingY(yScrollerSection), {passive:false});
    yScrollerDownButton.addEventListener("mouseup",  () => uss.stopScrollingY(yScrollerSection), {passive:false});
    yScrollerUpButton.addEventListener("mouseout",   () => uss.stopScrollingY(yScrollerSection), {passive:false});
    yScrollerDownButton.addEventListener("mouseout", () => uss.stopScrollingY(yScrollerSection), {passive:false});

    let bezierTitleTimeout = 0;
    cubicBezierCustomInputParameters[4].addEventListener("click", () => {
      window.clearTimeout(bezierTitleTimeout);
      let u0, u1, u2, u3;
      const title = document.getElementById("bezierTitle");

      u0 = Number.parseFloat(cubicBezierCustomInputParameters[0].value);
      u1 = Number.parseFloat(cubicBezierCustomInputParameters[1].value);
      u2 = Number.parseFloat(cubicBezierCustomInputParameters[2].value);
      u3 = Number.parseFloat(cubicBezierCustomInputParameters[3].value);

      if(isNaN(u0) || isNaN(u1) || isNaN(u2) || isNaN(u3)) {
        title.innerHTML = "Parameters must be numbers from 0 to 1";
        bezierTitleTimeout = window.setTimeout(() => title.innerHTML = "Choose custom cubic-bezier parameters", 5000);
        return;
      }

      const _inputCheck = u0 > 1 || u0 < 0 || u1 > 1 || u1 < 0 || u2 > 1 || u2 < 0 || u3 > 1 || u3 < 0;
      if(_inputCheck) {
        title.innerHTML = "Parameters must be numbers from 0 to 1";
        bezierTitleTimeout = window.setTimeout(() => title.innerHTML = "Choose custom cubic-bezier parameters", 5000);
        return;
      }

      uss.setStepLengthCalculator(CUSTOM_CUBIC_BEZIER(u0, u1, u2, u3));
      title.innerHTML = "All set, try it out !";
      bezierTitleTimeout = window.setTimeout(() => title.innerHTML = "Choose custom cubic-bezier parameters", 5000);
    }, {passive:true});

    pageScroller.addEventListener("wheel", event => {
      event.preventDefault();
      event.stopPropagation();
      if(lastAnchorPressed && uss.isScrolling()) uss.stopScrolling(pageScroller, () => console.log("Scrolling interrupted on both axises by the User"));
      
      lastAnchorPressed = null;
      uss.setYStepLengthCalculator(defaultEase, pageScroller, true);
      uss.scrollYBy(event.deltaY, pageScroller, null, false);
      return false;
    }, {passive:false});

    document.getElementById("stopScrollingX").addEventListener("click", () => {lastAnchorPressed = null; uss.stopScrollingX(pageScroller, () => console.log("scrollX stopped"));}, {passive:true});
    document.getElementById("stopScrollingY").addEventListener("click", () => {lastAnchorPressed = null; uss.stopScrollingY(pageScroller, () => console.log("scrollY stopped"));}, {passive:true});

    touchHelper(pageScroller, () => uss.setStepLengthCalculator(defaultEase, pageScroller, true));
  }
</script>
